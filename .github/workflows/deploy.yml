name: Deployment
on:
  push:
    branches:
      - main
env:
  MONGODB_DB_NAME: gha-demo
jobs:
  test:
    # We removed row 11 (environment: testing) as you requested
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v4 # Updated to v4 for compatibility

      # 1. Build your Docker image using the Dockerfile from your screenshot
      - name: Build Docker Image
        run: docker build -t my-app:latest .

      # 2. Run the container and pass your secrets as environment variables
      - name: Run Container
        run: |
          docker run -d \
            --name app-container \
            -p 8080:8080 \
            -e MONGODB_USERNAME=${{ secrets.MONGODB_USERNAME }} \
            -e MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }} \
            -e MONGODB_CLUSTER_ADDRESS=cluster0.ntrwp.mongodb.net \
            -e MONGODB_DB_NAME=gha-demo \
            my-app:latest
          
          sleep 10 # Wait for the app to try connecting to DB
          docker ps -a # Show if the container is "Up" or "Exited"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Output information
        run: echo "Docker tests passed. Ready for deployment."