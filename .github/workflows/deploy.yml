name: Deployment
on:
  push:
    branches:
      - main
env:
  MONGODB_DB_NAME: gha-demo
jobs:
  test:
    # We removed row 11 (environment: testing) as you requested
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v4 # Updated to v4 for compatibility

      # 1. Build your Docker image using the Dockerfile from your screenshot
      - name: Build Docker Image
        run: docker build -t my-app:latest .

      # 2. Run the container and pass your secrets as environment variables
      - name: Run Container and Tests
        env:
          MONGODB_CLUSTER_ADDRESS: cluster0.ntrwp.mongodb.net
          MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          PORT: 8080
        run: |
          docker run -d \
            --name app-container \
            -p 8080:$PORT \
            -e MONGODB_CLUSTER_ADDRESS=$MONGODB_CLUSTER_ADDRESS \
            -e MONGODB_USERNAME=$MONGODB_USERNAME \
            -e MONGODB_PASSWORD=$MONGODB_PASSWORD \
            -e MONGODB_DB_NAME=$MONGODB_DB_NAME \
            my-app:latest
          
          # Give the container a few seconds to start up
          sleep 10
          
          # Run tests inside the running container
          docker exec app-container npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Output information
        run: echo "Docker tests passed. Ready for deployment."